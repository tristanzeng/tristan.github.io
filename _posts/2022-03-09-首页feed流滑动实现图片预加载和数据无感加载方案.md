---
layout:     post
title:      首页feed流滑动实现图片预加载和数据无感加载方案
subtitle:   RecycleView优化
date:       2022-03-09
author:     Tristan
header-img: img/preload.jpeg
catalog: true
tags:
    - RecycleView
    - Fresco
    - 预加载
    - 无感加载

---

## 背景
1. 内容时代已来，很多APP都在用feed流的形式展示内容；同时呢，现如今又是一个存量用户的时代，各家APP对自身的用户体验越发重视。feed流无感加载，可以免除用户等待请求数据的时间，对提升用户浏览体验将会起到引领的作用。
2. 列表控件通常提供三种状态给开发者使用，分别是：拖动态、滑动态和闲置态。通常，为了减少不必要的性能损耗，列表处于滑动态时不加载图片。但是，列表的滑动过程是一个由快到慢的过程。当列表在慢下来时，用户即将所见的内容其实可以视为有效浏览的。

## 图片预加载方案
#### 现有方案
当列表处于滑动态时图片不会加载（滚动过快时视为无效浏览）；只有列表被拖动时加载图片，或者滑动停止后处于闲置态再加载图片。

流程图：

<img src="https://github.com/tristanzeng/tristanzeng.github.io/blob/master/img/preload1.png" width="auto"/>

代码实现：

<img src="https://github.com/tristanzeng/tristanzeng.github.io/blob/master/img/preload2.png" width="auto"/>

缺陷：用户每次滑动后，页面在滚动未停止前feed都是不显示图片的，只有页面滚动停止后等图片加载完毕才可以看到图片。从滑动开始到停止后图片加载完毕，这个阶段是一个列表从快到慢的滚动过程，整个过程页面图片空白率是100%，页面即便在慢下来时图片区依然是空白的（如下图所示）。

<img src="https://github.com/tristanzeng/tristanzeng.github.io/blob/master/img/preload3.png" width="auto"/>

#### 预加载方案
给列表控件增加一个“将停”态，待列表滚动变慢进入这个状态时提前加载图片。

<img src="https://github.com/tristanzeng/tristanzeng.github.io/blob/master/img/preload4.png" width="auto"/>

技术实现：重写列表控件的onScrolled(int velocityX, int velocityY)方法，其中velocityY表示垂直方向滑动速度。当列表处于滑动态时，计算滑动速度是否小于设定的阈值，如果小于的话则把列表状态改为“将停”的状态，同时通知状态已变更。编码如下：

<img src="https://github.com/tristanzeng/tristanzeng.github.io/blob/master/img/preload5.png" width="auto"/>

新增状态之前，只会在拖动态和闲置态加载图片；新增状态之后，在新的“将停”状态下也开启图片加载。

<img src="https://github.com/tristanzeng/tristanzeng.github.io/blob/master/img/preload6.png" width="auto"/>

将停状态下的效果图：

<img src="https://github.com/tristanzeng/tristanzeng.github.io/blob/master/img/preload7.png" width="auto"/>

#### 小结
给列表增加一个将停的状态，本质上是给列表提供了一个预处理的时机，让列表赋有了预加载能力。在将停态触发图片加载，当列表滚动变慢时图片也能及时显示，从而减少了正常视觉上的页面空白率，起到有效提升用户体验的作用。

## 数据无感加载方案

## 整体效果

## 总结
1. 通过自定义列表控件，给列表增加一个新的将停态，为列表控件赋能，让列表有了预加载机制。这个预加载机制，既可以保证滑动过程中不过度开销性能，又可以让图片及时显示。
