---
layout:     post
title:      ViewPager2
subtitle:   ViewPager禁用预加载
date:       2021-04-12
author:     Tristan
header-img: img/viewpager2_bg.png
catalog: true
tags:
    - 预加载
    - 懒加载
    - 离屏加载
    
---

## 背景
在开发首页、城市选择页和我的优惠券三个页面中，同时都使用了ViewPager用于横向页面切换作分页展示。ViewPager满足基本的功能需要是OK的，但要说完胜却有以下不足。比如，1)无法将离屏缓存页参数设置小于1，即不能关闭预加载；2)无法通过Adapter动态更新数据；3)禁止通过手势滑动翻页时，依然会出现页面滚动的迹象。

## 预加载
ViewPager默认情况下切换到当前页面时，会默认预加载左右两侧的布局到ViewPager中(尽管两侧的View并不可见)，我们称这种情况叫预加载；由于ViewPager对offscreenPageLimit设置了限制，页面的预加载是不可避免。
~~~
private static final int DEFAULT_OFFSCREEN_PAGES = 1;

public void setOffscreenPageLimit(int limit) {
    if (limit < DEFAULT_OFFSCREEN_PAGES) {//不允许小于1
        Log.w(TAG, "Requested offscreen page limit " + limit + " too small; defaulting to "
                + DEFAULT_OFFSCREEN_PAGES);
        limit = DEFAULT_OFFSCREEN_PAGES;
    }
    if (limit != mOffscreenPageLimit) {
        mOffscreenPageLimit = limit;
        populate();
    }
} 
~~~

## 懒加载
既然不能禁用预加载，那么就出现了懒加载，这是没有办法下的办法。
#### ViewPager如何实现懒加载
1. ViewPager实现懒加载要借助Fragment的setUserVisibleHint方法，缺此方法不可行。
~~~
@Override
public void setPrimaryItem(@NonNull ViewGroup container, int position, @NonNull Object object) {
    Fragment fragment = (Fragment)object;
    if (fragment != mCurrentPrimaryItem) {
        if (mCurrentPrimaryItem != null) {
            mCurrentPrimaryItem.setMenuVisibility(false);
            mCurrentPrimaryItem.setUserVisibleHint(false);//不可见
        }
        fragment.setMenuVisibility(true);
        fragment.setUserVisibleHint(true);//可见
        mCurrentPrimaryItem = fragment;
    }
}
~~~

Fragment中的setUserVisibleHint方法在v1.1.0中已经标记为已过时。

#### ViewPager2懒加载

## ViewPager2和ViewPager的区别
#### View实现
#### Adapter更新

## ViewPager2新功能
#### 新增API
#### Banner实现


## 参考文档
[RecyclerView缓存机制详解](https://www.cnblogs.com/ldq2016/p/9035948.html)<br/>
[ViewPager2重大更新，支持offscreenPageLimit](https://blog.csdn.net/Coo123_/article/details/92009724?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-4.control&dist_request_id=&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-4.control)<br/>
[ViewPager2和Fragment可见性及懒加载解决方案](https://zhangphil.blog.csdn.net/article/details/108893237)<br/>
[ViewPager2 详细使用](https://blog.csdn.net/baidu_40389775/article/details/103774074)<br/>
[RecyclerView扩展(五) - ViewPager2的源码分析](https://www.jianshu.com/p/70c5d3f0bb34)<br/>
[探索取代ViewPager的ViewPager2](https://www.jianshu.com/p/bd70970600aa)<br/>
[ViewPager2：官方Viewpager升级版来临](https://www.codercto.com/a/61727.html)<br/>
[ViewPager刷新数据，动态更改adapter的数量](https://blog.csdn.net/ArJinMC/article/details/48973485)<br/>
[ViewPager数据修改使用notifyDataSetChanged无刷新的问题](https://blog.csdn.net/Jafilah2010/article/details/51203537?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control&dist_request_id=1330144.34823.16182184090129255&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control)<br/>
[ViewPagerHelper](https://github.com/LillteZheng/ViewPagerHelper)<br/>
